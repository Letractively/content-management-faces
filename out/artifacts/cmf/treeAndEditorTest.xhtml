<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2011 Bill Reh.
  ~
  ~ This file is part of Content Management Faces.
  ~
  ~ Content Management Faces is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Lesser General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public License
  ~ along with this program.  If not, see <http://www.gnu.org/licenses/>
  -->

<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:cmf="http://tralfamadore.net/cmf/admin"
      xml:lang="en" lang="en">
<h:head>
    <title>Tree and Editor Test</title>
    <link rel="stylesheet" type="text/css"
          href="http://yui.yahooapis.com/2.8.2r1/build/treeview/assets/skins/sam/treeview.css"/>
    <script type="text/javascript"
            src="http://yui.yahooapis.com/2.8.2r1/build/yahoo-dom-event/yahoo-dom-event.js"></script>
    <script type="text/javascript" src="http://yui.yahooapis.com/2.8.2r1/build/treeview/treeview-min.js"></script>
    <link rel="stylesheet" type="text/css"
          href="http://yui.yahooapis.com/2.8.2r1/build/button/assets/skins/sam/button.css" />
    <link rel="stylesheet" type="text/css" href="http://http://developer.yahoo.com/yui/assets/dpSyntaxHighlighter.css"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type="text/javascript" src="ckeditor/ckeditor.js"></script>
    <style type="text/css">
        .ygtv-edit-TaskNode  {	width: 190px;}
        .ygtv-edit-TaskNode .ygtvcancel, .ygtv-edit-TextNode .ygtvok  {	border:none;}
        .ygtv-edit-TaskNode .ygtv-button-container { float: right;}
        .ygtv-edit-TaskNode .ygtv-input  input{	width: 140px;}
        .whitebg {
            background-color:white;
        }
        .ygtv-highlight1 {
            background: #6495ed;
        }
        .theScript {
            background: #8b0000;
        }
    </style>
</h:head>
<h:body>
    <f:view contentType="text/html">
        <h:form prependId="false">
            <table>
                <tr>
                    <td valign="top" style="padding-top: 20px;">
                        <cmf:tree value="#{tree.treeModel}" var="node">
                            <cmf:treeNode type="namespace">
                                <h:outputText value="#{node.namespace.nodeName} (ns)"/>
                                <h:commandButton value="Add ns" actionListener="#{admin.selectNamespace}">
                                    <f:param name="namespace" value="${node.namespace}"/>
                                    <f:ajax render="ckCode" onevent="doTheThing"/>
                                </h:commandButton>
                            </cmf:treeNode>
                            <cmf:treeNode type="content">
                                <h:outputText value="#{node.content.name} (c)"/>
                                <h:commandButton value="Edit" actionListener="#{admin.updateEditorContent}"
                                                 onclick="return checkTheDirty();">
                                    <f:param name="name" value="${node.content.name}"/>
                                    <f:param name="namespace" value="${node.content.namespace}"/>
                                    <f:ajax render="ckCode" onevent="doTheThing"/>
                                </h:commandButton>
                            </cmf:treeNode>
                            <cmf:treeNode type="script" styleClass="theScript">
                                <h:outputText value="#{node.script.name} (sc)"/>
                            </cmf:treeNode>
                            <cmf:treeNode type="style">
                                <h:outputText value="#{node.style.name} (st)"/>
                            </cmf:treeNode>
                        </cmf:tree>
                    </td>
                    <td>
                        <div style="width: 800px; margin-top: 10px;">
                            <h:inputTextarea id="ckCode" name="ckCode" value="#{admin.editor.value}" style="display:none"/>
                        </div>

                        <script type="text/javascript">
                            function doTheThing() {
                                var content = $("#ckCode").val();
                                CKEDITOR.instances.ckCode.setData(content);
                                CKEDITOR.instances.ckCode.resetDirty();
                                CKEDITOR.instances.ckCode.focus();
                            }

                            function checkTheDirty() {
                                if (CKEDITOR.instances.ckCode.checkDirty()) {
                                    var ret = confirm("Data is unsaved, continue?");
                                    if(ret)
                                        CKEDITOR.instances.ckCode.resetDirty();
                                    return ret;
                                }
                                return true;
                            }

                            function updateEditorAndResetDirty(xhr) {
                                if(xhr.status == "begin") {
                                    var editor = CKEDITOR.instances.ckCode;
                                    var data = editor.getData();
                                    $("#ckCode").html(data);
                                } else {
                                    CKEDITOR.instances.ckCode.resetDirty();
                                }
                            }


                            function updateField(editor) {
                                var data = editor.getData();
                                $("#ckCode").html(data);
                            }

                            function updateEditor() {
                                var editor = CKEDITOR.instances.ckCode;
                                var data = editor.getData();
                                $("#ckCode").html(data);
                            }

                            function resetDirty() {
                                CKEDITOR.instances.ckCode.resetDirty();
                            }

                            $(document).ready(function() {
                                CKEDITOR.on('instanceCreated', function(e) {
                                    var editor = e.editor;
                                    editor.addCss('.moo{font-size: 30pt;}');
                                });
                                CKEDITOR.replace('ckCode');
                            });
                        </script>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">
                        <h:commandButton value="Submit" actionListener="#{admin.saveEditorContent}" onclick="updateEditor(); return true;">
                            <f:ajax execute="ckCode" render="ckCode" onevent="resetDirty"/>
                        </h:commandButton>
                    </td>
                </tr>
            </table>
        </h:form>
    </f:view>
</h:body>
</html>
